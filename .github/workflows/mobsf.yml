name: MobSF Scan

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  mobsf-scan:
    runs-on: ubuntu-latest

    env:
      MOBSF_URL: https://your-public-mobsf-url.com  # ← Replace with your public MobSF URL
      MOBSF_API_KEY: ${{ secrets.MOBSF_API_KEY }}   # ← Store your key in GitHub Secrets

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Find APK/IPA files
        id: find_files
        run: |
          apk_files=$(find . -type f -name "*.apk")
          ipa_files=$(find . -type f -name "*.ipa")

          echo "apk_files<<EOF" >> $GITHUB_OUTPUT
          echo "$apk_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "ipa_files<<EOF" >> $GITHUB_OUTPUT
          echo "$ipa_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Scan files with MobSF
        run: |
          scan() {
            file="$1"
            echo "Uploading $file..."

            upload_response=$(curl -s -w "%{http_code}" -X POST "$MOBSF_URL/api/v1/upload" \
              -H "Authorization: $MOBSF_API_KEY" \
              -F "file=@$file")

            http_code="${upload_response: -3}"
            response_body="${upload_response:: -3}"

            echo "MobSF Response: $response_body"

            if [[ "$http_code" != "200" ]]; then
              echo "❌ Upload failed. HTTP $http_code"
              exit 1
            fi

            scan_hash=$(echo "$response_body" | jq -r '.hash')
            if [[ -z "$scan_hash" || "$scan_hash" == "null" ]]; then
              echo "❌ Could not extract scan hash from response."
              exit 1
            fi

            echo "✅ Uploaded successfully. Hash: $scan_hash"

            echo "Initiating scan..."
            curl -s -X POST "$MOBSF_URL/api/v1/scan" \
              -H "Authorization: $MOBSF_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"hash\":\"$scan_hash\"}"

            echo "Downloading JSON report for $file..."
            report_name="$(basename "$file").json"
            curl -s -X POST "$MOBSF_URL/api/v1/report_json" \
              -H "Authorization: $MOBSF_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"hash\":\"$scan_hash\"}" \
              -o "$report_name"
          }

          # Run scan for all APK files
          for file in ${{ steps.find_files.outputs.apk_files }}; do
            scan "$file"
          done

          # Run scan for all IPA files
          for file in ${{ steps.find_files.outputs.ipa_files }}; do
            scan "$file"
          done

      - name: Upload MobSF Reports
        uses: actions/upload-artifact@v4
        with:
          name: mobsf-reports
          path: |
            *.json
