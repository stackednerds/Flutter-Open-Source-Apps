name: MobSF Scan

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:

jobs:
  mobsf-scan:
    runs-on: ubuntu-latest
    name: Scan mobile apps with MobSF

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Find APK and IPA files
        id: find_files
        run: |
          apk_files=$(find . -type f -name "*.apk")
          ipa_files=$(find . -type f -name "*.ipa")
          echo "apk_files<<EOF" >> $GITHUB_OUTPUT
          echo "$apk_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "ipa_files<<EOF" >> $GITHUB_OUTPUT
          echo "$ipa_files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Scan APK and IPA files with MobSF
        env:
          MOBSF_URL: ${{ secrets.MOBSF_URL }}
          MOBSF_API_KEY: ${{ secrets.MOBSF_API_KEY }}
        run: |
          scan() {
            file="$1"
            echo "Uploading $file..."
            response=$(curl -s -X POST "$MOBSF_URL/api/v1/upload" \
              -H "Authorization: $MOBSF_API_KEY" \
              -F "file=@$file")

            scan_hash=$(echo "$response" | jq -r '.hash')
            if [ "$scan_hash" == "null" ]; then
              echo "Failed to upload $file"
              exit 1
            fi

            echo "Uploaded successfully. Hash: $scan_hash"

            echo "Initiating scan..."
            curl -s -X POST "$MOBSF_URL/api/v1/scan" \
              -H "Authorization: $MOBSF_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"hash\":\"$scan_hash\"}"

            echo "Getting JSON report for $file..."
            curl -s -X POST "$MOBSF_URL/api/v1/report_json" \
              -H "Authorization: $MOBSF_API_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"hash\":\"$scan_hash\"}" \
              -o "$(basename "$file").json"
          }

          # Scan all APKs
          echo "${{ steps.find_files.outputs.apk_files }}" | while read -r apk; do
            [ -z "$apk" ] && continue
            scan "$apk"
          done

          # Scan all IPAs
          echo "${{ steps.find_files.outputs.ipa_files }}" | while read -r ipa; do
            [ -z "$ipa" ] && continue
            scan "$ipa"
          done

      - name: Upload MobSF Reports
        uses: actions/upload-artifact@v4
        with:
          name: mobsf-reports
          path: |
            *.json
